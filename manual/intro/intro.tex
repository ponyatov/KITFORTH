\clearpage
\secly{Программирование для кофеварки ?!}\label{intro}

\noindent
Бадумтс-с-с! Вся семья сбежалась смотреть на чудо\ --- \textit{руководство
программиста}, выпавшее из коробки\note{пока доступно только в электронном виде
на сайте проекта:\\\url{https://github.com/ponyatov/KITFORTH/releases/latest/} в
виде \file{.pdf}\ файла} с вафельницей или минипечкой. К сожалению, не с
чайником или плитой: технологию IoT\note{интернет вещей, Internet-of-Things}\
поддерживают пока только два устройства, которые я кое-как смог запихать на
кухню:
\begin{itemize}
  \item 
Микропечь
\hremd{Kitfort KT-1709}{https://kitfort.ru/catalog/duhovki/17341/}
  \item 
Вафельница для бельгийских вафель
\hremd{Kitfort KT-1646}{https://kitfort.ru/catalog/vafelnitsa/20584/}
\end{itemize}

\noindent
Хотя вряд ли, скорее всего вы купили комплект ``микродуховка для программиста''
сами себе, потому что вас зацепила идея пощщупать технологию интернета вещей
вживую, пользуясь готовым устройством из коробки.

\clearpage
\secly{Мир свихнулся: Linux даже в тостере}

Технология IoT была для вас только хайпом, потому что до сих пор цена на
``умные'' бытовые устройства зашкаливала, чтобы взять их просто ``на
попробовать''. Другая проблема, куда более важная\ --- каждый производитель
пилит свой собственный набор протоколов, и полностью закрытое программное
обеспечение. Особенно весело с этим у китайской продукции с AliExpress, весело
продающейся и в ближайших магазинах под нескольми дешевыми типа брендами.
Вы покупаете устройство, например action камеру. В комплекте идет приложение под
Android\note{то есть все остальные виды компьютеров сразу в пролете}.
Допустим вы его ставите, дав разрешение на все возможные действия, включая
международные звонки и снятие отпечатков пальцев. Через два месяца приложение
обновляется на Play Store, и выясняется что теперь оно требует как минимум
Android 99, и не работает ни на одном из ваших телефонов.

\begin{framed}
\noindent
Закрытая прошивка имеет одно очень важное свойство\ --- вы можете использовать
устройство только так, как это заложил производитель. Все возможные проблемы и
ошибки в прошивке, приводящие к неправильному функционированию,
\emph{принципиально неизлечимы}. Даже если предусмотрена возможность ее
обновления, чаще всего производитель не исправляет некричные ошибки, забивает на
поддержку сразу после выхода следующей модели, и уж тем более не предоставляет
никакой технической поддержки пользователям, хотящим странного.
\end{framed}

\noindent
Для дорогих брендовых моделей ситуация чуть получше, выходит 1-2 обновления,
поддерка старых моделей прекращается немного позже, а опции и нестандартные
решения предоставляются по стоимости, сравнимой с новым устройством следующего
поколения.

\clearpage
\secly{OpenSource \& OpenHardware}

Идеология OpenSource предлагает совершенно другие возможности даже неопытному
пользователю, не говоря о тех кто в теме \term{embedded разработки}.

Производитель оборудования полностью снимает с себя ответственность по поддержке
продукта, предоставляя только ``железо'', и прошивку обеспечивающую вам только
базовые функции, доступные из коробки. Взамен производитель предоставляет полный
исходный код прошивки, и общую схему устройства, на которой указано куда и что
подключено.

В результате вы как конечный пользователь, от этого только выигрываете, так как
\emph{поддержку берет на себя сообщество пользователей}. Общаясь в сети на
открытых ресурсах\note{как минимум веб-форум производителя}, вы можете найти
способ реализовать любые ваши хотелки, даже если совершенно не разбираетесь в
программировании\ --- если идея интересна, найдутся достаточно опытные
пользователи, способные ее реализовать, и поделиться с вами результатом.

Правильно написанная документация, и помощь открытого сообщества поможет вам при
желании освоить программирование устройства на самом минимальном уровне, и при
этом делать достаточно сложные и нестандартные вещи. \emph{Даже просто повторяя
и комбинируя шаги, описанные в постах на веб-форуме, вы можете получить
возможности, недостижимые в традиционных даже самых дорогих моделях}. Для тех
же, кто уже имеет некоторые навыки, особенно в электронике, открываются
совершенно неограниченные возможности.

Если производитель закроет производство вашей модели, даже через несколько лет
вы сможете так же пользоваться вашей умной плитой, добавлять новые фишки и
нестандартные применения, до тех пор пока устройство в принципе способно
работать.

\clearpage
\secly{Почему именно бытовая техника для кухни?}

Готовка\ --- процесс достаточно сложный, но при этом он неплохо поддается
автоматизации. Возьмите любой рецепт, и вы сразу увидите в нем
последовательность действий\ --- \termdef{алгоритм}{алгоритм}. В очень многих
учебниках по программированию с первых страниц именно рецепты приводятся как
полный аналог выполнения \textit{вами} \termdef{программы}{программа}, то есть
последовательностей действий, иногда разных в зависимости от условий.

Взгляните на любую СВЧ-печь, или плиту, даже самую примитивную\ --- вы увидите
\termdef{устройства ввода}{устройство ввода}: ручки установки режима
(температуры, можности), и установки временных интервалов (таймер). На моделях
чуть подороже добавляются кнопки выбора \term{опций}\ --- экономичный режим,
кофе двойной плотности, стирка с отсрочкой. Почти любой бытовой прибор сообщает
вам свое состояние через \termdef{устройства вывода}{устройство вывода}: как
минимум есть лампочки включения/готовности, текущее время и дата, отсчет
таймера, температура на которую настроена духовка, и т.п. На дорогих моделях
стоят как минимум текстовые, и иногда и графические \term{дислпеи}.

\bigskip
Но все же не хватает чего-то важного. Каждый раз, на каждом следующем пункте
рецепта вам нужно вручную выставлять единственный таймер, не забыть сделать то,
порезать и положить сё, догнать внезапно убежавшее за молоком кофе, потушить
курицу\ldots водой потому что вам позвонили, и вы забыли ее выключить.

Никто не предлагает делать полную автоматизацию процесса с дозаторами, и
мешалками (разве что домашние пивовары, ау!), но множество вещей крайне полезно:
\begin{itemize}[nosep]
  \item точный контроль температуры, неплохо если с термопрофилями (изменение
  температуры по расписанию)
  \item отмеривание времени\ --- несколько независимых таймеров, до десятка,
  которые при необходимости могут запускать и останавливать друг друга
  \item оповещение пользователя о \term{событиях}, причем разных и разным
  звуком, а не единственный будильник для четырех включенных конфорок.
  \item весы, которые могут послать электрокастрюле сколько мяса вы в нее
  кладете, чтобы она пересчитала время и мощность нагрева.
\end{itemize}

\medskip\noindent
Другими словами, \emph{не хватает возможности полноценного} относительно
сложного \emph{программирования} с реакцией на внешние события, взаимодействия с
человеком, и устройств друг с другом.

Да, вы можете запрограммировать старальную машину\ --- включиться утром. Но нет
способа указать ей делать это только в выходные, \textbf{или} если нет дома
какого-то члена семьи (телефон не подключался к WiFi несколько часов),
\textbf{и} откладывать запуск каждого цикла стирки пока включена плита, чтобы не
перегружать проводку.

\clearpage
Первым кандидатом на переделку была выбрана самая дешевая и компактная
микропечь\ --- очень универсальное по функциям устройство, регулярно
востребованное потенциальной целевой аудиоторией для разогрева бутеров:
``паяльниками'' и программистами, которые могут стать костяком открытого
сообщества разработчиков.

\fig{img/KT_1907.png}{height=.65\textheight}

\noindent
\hremd{Kitfort KT-1709}{https://kitfort.ru/catalog/duhovki/17341/} самый дешевый
и компактный вариант из всего, что было доступно в магазинах, при этом имеет
идеальное сочетание размеров и дизайна, для установке на столе
среднестатистического кнопкодава. Также имеет значительную конструкционную
особенность\ --- блок автоматики расположен в подвале, регулятор расположен в
удачном месте для замены на джойстик или энкодер, а конструкция корпуса позвляет
организовать принудительный всос \emph{холодного} воздуха для охлаждения
электроники.

\bigskip\textit{
К сожалению по первому осмотру подвал не подвал, и в нем уместятся только пара
оптосимисторов, и крутилка\ --- электронику придется выносить в отдельном
блоке.}

\clearpage
\secly{\linux\ или не \linux, вот в чем вопрос}

\noindent
и вопрос неоднозначный:

\medskip\noindent
\begin{tabular}{l l l l l l}
модуль & & процессор & цена & WiFi & BT \\
\hline
ESP8266EX & & esp8266 & \$2.9 & \checkmark \\
ESP32 && Xtensa LX6 & \$4.1 & \checkmark & 4.2/BLE \\
& arm926t & NUC906DK61Y & \$8.17 & \\
HLK-RM04 & misp32 & RT5350F & \$20.5 & \checkmark \\
Raspberry Pi 3 B+ & arm & BCM2837B0 & \$49.7 & \checkmark \\
&& 64bit 4x1.4G & \\
\end{tabular}

\medskip\noindent
ESP32 кажется идеалом, но он не умеет в \linux, следующий по цене -- нюк, но у
него нет в комплекте WiFi. Ставить обоих в спарку, или использовать ``Халк'' на
RT5350F\ -- перебор по цене и ресурсам с учетом задач. Raspberry неадекватны
задаче по цене, но имеют самое дружественное сообщество.

\clearpage

Если учесть зоопарк модулей, которые желающие захотят использовать в проектах по
айотофикации домашней техники\note{не будем ограничивать пользователя одним
поставщиком всего с парой моделей\ --- на Али полно вариантов максимально
дешевой и условно рабочей бытовой техники для экспериментов}, становится страшно
от осознания, какой зоопарк ОС и средств разработки придется осваивать любому,
кто попытается просто сунуться в программирование вафельницы.

Ближайший вменяемый вариант для начинающего пользователя\ --- клоны среды
Arduino. Но тут мы влипаем в другую крайность: каждый раз когда производитель
бытовой техники, или ``паяльник'' хотят применить нетиповой процессорный модуль,
им потребуется реализовывать плагин для среды Arduino (средства разработки и
библиотеки), и поддерживать их в варианте 3х операционных систем
(Linux/Windows/MacOS) с вариациями.

Одновременно полностью за бортом остаются мобильные телефоны и планшеты, для
которых как известно реализации Arduino IDE так и не появилось.

\begin{framed}\noindent
Итого, получаем требование: \emph{любое бытовое IoT-устройство должно
обеспечивать возможность} не только использования, но и \emph{программирования с
управляющего устройства любого типа}, и прежде всего\\ --- любого мобильного
телефона.
\end{framed}

Таким образом, у нас остается только два варианта\ --- веб-интерфейс, или
командная консоль через последовательный интерфейс, завернутый в WiFi или
Bluetooth. BT часто нет на десктопных ПК, поэтому WiFi+BT.

\clearpage
Теперь посмотрим с точки зрения массового производителя. При массовом
произвостве даже разница 1-2\$ в себестоимости процессорного модуля играет
значительную роль, особенно на фоне оптосимисторов для управления ТЭНами.

Стеки WiFi/BT уже требуют микроконтроллеров и SoC с приличной вычислительной
мощностью и объемом ОЗУ. Внимательно рассматривая таблицу выше, обнаруживаем
vendor lock\ --- из доступных по ценам у нас оказывается только ESP32 (и ESP8266
без BT).

При этом у нас есть такая замечательная штука как микроконтроллер STM32F103C8T6
со встроенным USB по \$1.5 (64K Flash, 20K SRAM). Для максимального удешевления
очень хочется повесить STM32F030C8T6 (64K/8K)\ ---
экономим на изоляции и разъеме USB, ставим только PLS-R гребенку, а USB/Serial с
опторазвязкой пользователь пусть покупает отдельно (нужно не всем, снижаем
себестоимость).

\clearpage
\secly{Язык \F\ --- вечно живой}

\noindent
Резюмируем: для веб-интерфейса нужны значительные аппаратные ресурсы для WiFi,
BT и TPC/IP стека и веб-сервера, поэтому для максимального удешевления доступен
только UART TLL, и опционально коннекторы WiFi/BT/USB по вкусу конкретного
пользователя.

